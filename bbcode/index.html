<meta charset="UTF-8"> <!-- SHUT THE [HECK] UP -->

<link rel="stylesheet" href="http://smilebasicsource.com/styles/main.css?version=1496427257">
<link rel="stylesheet" href="bad.css">
<section class="forum">
<section class="thread">
<ul class="forumposts">
	<li>
		<post-info>
			<a class="postnumber" href="https://www.youtube.com/watch?v=dQw4w9WgXcQ">#7</a>
		</post-info>

		<user-info>
			<img src="/user_uploads/avatars/t1500537705.jpg" class="smallavatar" data-uid="286">
			<post-count title="Post Count">âœŽ 7</post-count>
			<user-name>
				<a class="userhover" >GRAND DAD</a> 
				<user-badges>
				</user-badges>
			</user-name>
		</user-info>

		<post-content class="bbcode" id="div"></post-content>

		<button-container>
			<button type="button" class="edit-button"> Edit </button>
			<button type="button" class="delete-button"> Delete </button>

			<button type="button" class="quote-button" accesskey="q">Quote</button>
			<button type="button" class="flag-button" id="20312_status">Flag</button>
		</button-container>

		<post-dates>
			<posted-on>
				Posted <time datetime="2018-01-12T13:23:44+00:00" title="1/12/2018, 8:23:44 AM">61 minutes ago</time>
			</posted-on>
		</post-dates>
	</li>
</ul>
<form id="submit-post">
<textarea id="textarea" name="content" placeholder="Post to this thread. You can use bbcode such as [b], [i], [u], [s], [url], [img], and [code] to style your post. Search for 'bbcode' for examples." rows="10" cols="80" maxlength="60000" required="" accesskey="r"></textarea>
<button onclick="update()" type="button">Post</button>
</form>
</section>
</section>
<style>
	div#div {
		white-space:pre-wrap;
		line-height: 130%;
		font-family: sans-serif;
	}
	pre{
		border: 1px solid red;
		margin: 0;
	}
	div > table{
		white-space:inherit; /* why is this not default? */ /* gosh I hate CSS comments */
		border: 1px solid gray;
	}
	table table{
		width: 100%;
		height: 100%;
		/*border: none;*/
	}
	td{
		padding: 0.1rem;
	}
</style>
<script src="../sbhighlight2/sbhighlight.js"></script>
<script>
function update(){
	div.innerHTML=parseBBCode(textarea.value);
	highlightList(div.querySelectorAll("code"))
}

function highlightList(list){
	for(var i=0;i<list.length;i++){
		applySyntaxHighlighting(list[i])
	}
}

function process_code(inner,attribute){
	return {inner:htmlHighlight(inner)};
}

var tagTable={
	"table":{index:0,open:"<table rules='all'><tr><td>",close:"</td></tr></table>",block:true},
	"col":{index:1,open:"</td><td>",block:true},
	"row":{index:2,open:"</td></tr><tr><td>",block:true},
	"code":{index:3,open:"<code>",close:"</code>",code:true,block:true,process:process_code},
	"icode":{index:4,open:"<inline-code>",close:"</inline-code>",code:true},
	"i":{index:5,open:"<i>",close:"</i>"},
	"b":{index:6,open:"<b>",close:"</b>"},
	"u":{index:7,open:"<u>",close:"</u>"},
	"img":{index:8,open:"<img src=\"",close:"\">"},
	length:9
}

function escapeHTML(text){return text.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/"/g,"&quot;");}

function array(length){
	var array=new Array(length);
	for(var i=0;i<length;i++){
		array[i]=0;
	}
	return array;
}
  
function parseBBCode(input){
	var c
	var i=-1
	var text=""
	var insideCode=null
	var removeNextLineBreak=false;
	var inner="";
	
	function next(){
		c=input.charAt(++i);
	}
	
	var openedTags=array(tagTable.length);
	var tagStart,tagEnd,tagNameStart,tagNameEnd,propertyStart,propertyEnd
	function htmlTag(){
		var closing=false;
		//closing tag
		if(input[tagNameStart]=="/"){
			tagNameStart++
			closing=true;
		}
		//tag name
		var tagName=input.substring(tagNameStart,tagNameEnd);
		//tag data
		var tagInfo=tagTable[tagName];
		//if invalid tag, or invalid closing tag, or invalid opening tag:
		if(!tagInfo || closing&&!tagInfo.close || !closing&&!tagInfo.open){
			return escapeHTML(input.substring(tagStart,tagEnd));
		}
		//if closing tag for current code block
		if(closing && insideCode==tagName){
			insideCode=null;
		}
		//if still inside code, don't continue parsing
		if(insideCode || closing && openedTags[tagInfo.index]<1){
			return escapeHTML(input.substring(tagStart,tagEnd));
		}
		//closing tag
		if(closing){
			openedTags[tagInfo.index]--;
		//opening tag that can be closed
		}else if(tagInfo.close){
			openedTags[tagInfo.index]++;
		}
		//remove line breaks at start/end of blocks
		if(tagInfo.block){
			removeNextLineBreak=true;
		}
		//if opening code tag
		if(!closing && tagInfo.code){
			insideCode=tagName;
		}
		//finally return the html
		if(closing){
			return tagInfo.close;
		}else{
			return tagInfo.open;
		}
	}	
	
	next();
	while(c){
		tagStart=i;
		if(c=="["){
			next();
			tagNameStart=i;
			while(c&&c!="]"&&c!="="){
				next();
			}
			tagNameEnd=i;
			if(c=="="){
				next();
				propertyStart=i;
				while(c && c!="]"){
					next();
				}
				propertyEnd=i;
			}else{
				propertyStart=propertyEnd=i;
			}
			if(c){
				next();
				tagEnd=i;
				text+=htmlTag();
			}else{
				text+=escapeHTML(input.substring(tagStart,i));
			}
		}else{
			//skip character if line break
			if(removeNextLineBreak && c=="\n"){
				next();
				tagStart=i;
			}
			removeNextLineBreak=false;
			while(c && c!="["){
				next();
			}
			text+=escapeHTML(input.substring(tagStart,i));
		}
	}
	for(i=0;i<openedTags.length;i++){
		if(openedTags[i]){
			return escapeHTML(input);
		}
	}
	return text;
}
</script>
